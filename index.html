<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Master Toolkit</title>
    <style>
        /* --- GLOBAL STYLES & BASE THEME --- */
        :root {
            --primary-bg: #1a1a1d;
            --secondary-bg: #2d2d34;
            --card-bg: #25252a;
            --text-color: #e2e2e2;
            --header-color: #c5c6c7;
            --border-color: #4a4a4a;
            --font-main: 'Georgia', serif;
            --font-header: 'Trajan Pro', 'Palatino Linotype', serif;
            
            --page-accent-primary: #c59b34; /* Gold */
            --page-accent-secondary: #a87d22;
            --page-bg-image: radial-gradient(circle, #3d3d44, var(--primary-bg));
        }

        body { font-family: var(--font-main); background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 10px; line-height: 1.6; transition: background-color 0.5s ease; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: var(--secondary-bg); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color); }
        .page { display: none; background: var(--page-bg-image); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .page.active { display: block; }

        h1, h2 { font-family: var(--font-header); text-align: center; letter-spacing: 2px; padding-bottom: 10px; border-bottom: 2px solid; }
        h1 { font-size: 2.2em; color: var(--page-accent-primary); border-color: var(--page-accent-secondary); text-shadow: 0 0 10px var(--page-accent-primary); }
        h2 { font-size: 1.8em; color: var(--header-color); border-color: var(--border-color); }
        p { text-align: center; margin-bottom: 25px; font-style: italic; color: #b0b0b0; }

        .btn { display: block; width: 80%; max-width: 400px; padding: 15px 20px; margin: 15px auto; font-family: var(--font-header); font-size: 1.1em; letter-spacing: 1px; color: var(--text-color); background-color: var(--page-accent-primary); border: 2px solid var(--page-accent-secondary); border-radius: 5px; cursor: pointer; transition: all 0.3s ease; text-decoration: none; position: relative; overflow: hidden; }
        .btn:hover { background-color: var(--page-accent-secondary); transform: translateY(-3px); box-shadow: 0 4px 15px color-mix(in srgb, var(--page-accent-primary), transparent 50%); }
        .btn-return { background-color: #4a4a4a; border-color: #333; margin-top: 30px; }
        .btn-return:hover { background-color: #6a6a6a; }
        
        select, input[type="text"], textarea { width: 100%; padding: 10px; background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; font-family: var(--font-main); font-size: 1em; box-sizing: border-box; }
        .output-area { background-color: color-mix(in srgb, var(--card-bg), transparent 20%); backdrop-filter: blur(2px); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-top: 20px; min-height: 100px; white-space: pre-wrap; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); font-size: 1.1em; }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px 0 var(--page-accent-primary); } 50% { transform: scale(1.02); box-shadow: 0 0 20px 4px var(--page-accent-primary); } }
        @keyframes flicker { 0%, 100% { opacity: 1; box-shadow: 0 0 8px 2px var(--page-accent-primary); } 50% { opacity: 0.9; box-shadow: 0 0 12px 4px var(--page-accent-primary); } }
        @keyframes spark { 0% { background-position: -50%; } 100% { background-position: 150%; } }
        @keyframes sky-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes click-press { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(2px); } }

        /* --- PAGE-SPECIFIC THEMES --- */
        #main-page { --page-accent-primary: #c59b34; --page-accent-secondary: #a87d22; }
        #main-page .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        #main-page .btn { animation: pulse 4s infinite ease-in-out; }

        #campaign-tracker { --page-accent-primary: #a05a2c; --page-accent-secondary: #7a4521; --page-bg-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVzPSJzdGl0Y2giLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWx0ZXI9InVybCgjbnoaXNlKSIgb3BhY2l0eT0iMC4xNSIvPjwvc3ZnPg=='), radial-gradient(circle, #5a3e2b, #3a281c); }
        #campaign-tracker h1 { color: #eaddc0; text-shadow: 0 0 5px #a05a2c; }
        
        #npc-populator { --page-accent-primary: #ffab40; --page-accent-secondary: #e08c24; --page-bg-image: radial-gradient(circle, #5e3c1a, #2b1d0e); }
        #npc-populator .btn { animation: flicker 3s infinite; }

        #location-generator { --page-accent-primary: #4CAF50; --page-accent-secondary: #388E3C; --page-bg-image: radial-gradient(circle, #254426, #142515); }

        #situational-catalyst { --page-accent-primary: #D32F2F; --page-accent-secondary: #B71C1C; --page-bg-image: radial-gradient(circle, #4e1a1a, #2a0e0e); }
        #situational-catalyst .btn { background: linear-gradient(110deg, var(--page-accent-primary) 30%, var(--page-accent-secondary) 40%, var(--page-accent-secondary) 60%, var(--page-accent-primary) 70%); background-size: 200% 100%; animation: spark 3s linear infinite; color: white; }

        #environmental-generator { --page-accent-primary: #03A9F4; --page-accent-secondary: #0288D1; --page-bg-image: linear-gradient(270deg, #13223f, #3e537a, #13223f); background-size: 200% 200%; animation: sky-gradient 15s ease infinite; }
        
        #puzzle-trap-creator { --page-accent-primary: #CD7F32; --page-accent-secondary: #a96624; --page-bg-image: radial-gradient(circle, #55483b, #302820); }
        #puzzle-trap-creator .btn:active { animation: click-press 0.2s 1; }

        /* --- SPELLCRAFT SCRIBE THEME & LAYOUT (UPDATED) --- */
        #spellcraft-scribe { --page-accent-primary: #8A2BE2; --page-accent-secondary: #6012a3; --page-bg-image: radial-gradient(circle, #2c1e3e, var(--primary-bg)); }
        .spellcraft-layout { display: flex; gap: 20px; }
        .tome { flex: 3; display: flex; flex-direction: column; background: #e8dcb5; color: #3b2f2f; border: 10px solid #5a3a22; border-radius: 5px; box-shadow: 5px 5px 15px rgba(0,0,0,0.7); padding: 15px; min-height: 60vh; }
        .chat-history { flex-grow: 1; overflow-y: auto; padding: 10px; font-family: var(--font-main); color: #3b2f2f; }
        .chat-history pre { white-space: pre-wrap; word-wrap: break-word; font-size: 1.1em; }
        .chat-history pre strong { color: var(--page-accent-secondary); font-family: var(--font-header); letter-spacing: 1px; }
        .chat-input-area { display: flex; gap: 10px; margin-top: 15px; }
        .chat-input-area input { flex-grow: 1; background: #fdf6e3; border: 1px solid #c8b898; }
        .chat-input-area button { background-color: var(--page-accent-primary); border: 2px solid var(--page-accent-secondary); animation: pulse 2s infinite; color: white; border-radius: 5px; cursor: pointer; padding: 0 15px; font-family: var(--font-header); }
        .spellbook-sidebar { flex: 1; background-color: var(--card-bg); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; }
        .spellbook-sidebar h3 { color: var(--header-color); margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); text-shadow: 0 0 5px var(--page-accent-primary); }
        .spellbook-list { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .spellbook-list li { padding: 10px; background: var(--secondary-bg); margin-bottom: 5px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s; border-left: 3px solid transparent; }
        .spellbook-list li:hover { background-color: var(--page-accent-secondary); color: white; border-left: 3px solid var(--page-accent-primary); }

        /* --- RESPONSIVE MEDIA QUERY FOR MOBILE STACKING --- */
        @media (max-width: 768px) {
            body { padding: 5px; }
            h1 { font-size: 1.8em; }
            .spellcraft-layout {
                flex-direction: column; /* Stack vertically */
                gap: 25px;
            }
            .tome {
                min-height: 50vh; /* Ensure it has enough space */
            }
            .spellbook-sidebar {
                min-height: 25vh;
                max-height: 40vh; /* Prevent it from being too tall */
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Main page and other tool pages HTML is unchanged. -->
        <div id="main-page" class="page active">...</div>
        <div id="campaign-tracker" class="page">...</div>
        
        <!-- ==================== SPELLCRAFT SCRIBE (UPDATED HTML) =================== -->
        <div id="spellcraft-scribe" class="page">
            <h1>Spellcraft Scribe</h1>
            <p>Generate detailed D&D 5e spells from your ideas using the built-in Grimoire. No internet needed.</p>
            <div class="spellcraft-layout">
                <div class="tome">
                    <div class="chat-history" id="chat-history">
                        <p style="color: #5a3a22; text-align: left;"><i>The tome awaits your arcane inscription...</i></p>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="spell-idea-input" placeholder="e.g., A cantrip that creates shadowy chains">
                        <button id="send-spell-idea">Conjure</button>
                    </div>
                </div>
                <div class="spellbook-sidebar">
                    <h3>My Spellbook</h3>
                    <ul class="spellbook-list" id="spellbook-list">
                        <!-- Saved spells will appear here -->
                    </ul>
                </div>
            </div>
            <button class="btn btn-return" onclick="showPage('main-page')">Return to Main</button>
        </div>
        
        <!-- Other tool pages HTML (omitted for brevity, but still present in full script) -->
        <div id="npc-populator" class="page">...</div>
        <div id="location-generator" class="page">...</div>
        <div id="situational-catalyst" class="page">...</div>
        <div id="environmental-generator" class="page">...</div>
        <div id="puzzle-trap-creator" class="page">...</div>
    </div>

<script>
    // ======================= APP INITIALIZATION & NAVIGATION ==========================
    // (This part is unchanged)
    document.addEventListener('DOMContentLoaded', () => { initializeCampaignTracker(); renderSpellbook(); showPage('main-page'); });
    const pages = document.querySelectorAll('.page');
    function showPage(pageId) {
        pages.forEach(page => page.classList.toggle('active', page.id === pageId));
        const activePage = document.getElementById(pageId);
        const style = getComputedStyle(activePage);
        document.body.style.setProperty('--page-accent-primary', style.getPropertyValue('--page-accent-primary'));
        document.body.style.setProperty('--page-accent-secondary', style.getPropertyValue('--page-accent-secondary'));
    }
    const getRandom = (arr) => arr ? arr[Math.floor(Math.random() * arr.length)] : '';

    // ======================= SPELLCRAFT SCRIBE (UPDATED JAVASCRIPT) =========================
    const spellData = {
        keywords: {
            fire: { school: "Evocation", damage: "Fire", adjective: "Fiery", noun: "Flame" },
            ice: { school: "Evocation", damage: "Cold", adjective: "Icy", noun: "Shard" },
            frost: { school: "Evocation", damage: "Cold", adjective: "Glacial", noun: "Frost" },
            lightning: { school: "Evocation", damage: "Lightning", adjective: "Crackling", noun: "Bolt" },
            thunder: { school: "Evocation", damage: "Thunder", adjective: "Thundering", noun: "Boom" },
            acid: { school: "Evocation", damage: "Acid", adjective: "Corrosive", noun: "Splash" },
            poison: { school: "Necromancy", damage: "Poison", adjective: "Venomous", noun: "Fumes" },
            shadow: { school: "Illusion", damage: "Psychic", adjective: "Shadowy", noun: "Tendril" },
            light: { school: "Evocation", damage: "Radiant", adjective: "Brilliant", noun: "Beam" },
            heal: { school: "Abjuration", damage: "Healing", adjective: "Mending", noun: "Light" },
            charm: { school: "Enchantment", damage: "Charm", adjective: "Beguiling", noun: "Gaze" },
            illusion: { school: "Illusion", damage: "Illusion", adjective: "Phantasmal", noun: "Image" },
            force: { school: "Evocation", damage: "Force", adjective: "Arcane", noun: "Missile" },
            chains: { school: "Conjuration", damage: "Restrain", adjective: "Binding", noun: "Chains" },
            spear: { school: "Conjuration", damage: "Piercing", adjective: "Conjured", noun: "Spear" },
        },
        templates: {
            name: ["{Adjective} {Noun}", "{Noun} of {Damage}", "{Adjective} Grasp", "Arcane {Noun}"],
            level: ["Cantrip", "1st-level", "2nd-level", "3rd-level"],
            castingTime: ["1 Action", "1 Bonus Action"],
            range: ["30 feet", "60 feet", "Touch", "Self"],
            components: ["V, S", "S, M", "V, S, M"],
            duration: ["Instantaneous", "Concentration, up to 1 minute", "1 round"],
            description: [
                "A shimmering {Noun} of {Damage} energy streaks toward a creature within range. Make a ranged spell attack. On a hit, the target takes 1d8 {Damage} damage.",
                "You unleash a burst of {Damage} energy. Each creature in a 15-foot cone must make a Dexterity saving throw. A creature takes 2d6 {Damage} damage on a failed save, or half as much on a successful one.",
                "You touch a creature. The target must succeed on a Wisdom saving throw or be {Damage}ed by you for the duration. The charmed creature regards you as a friendly acquaintance.",
                "{Adjective} {Noun | plural} erupt from the ground in a 10-foot square. That area becomes difficult terrain, and any creature that starts its turn there takes 1d6 {Damage} damage.",
                "You evoke a minor {Damage} in a 5-foot cube. It creates a harmless sensory effect, such as faint whispers, a puff of smoke, or an illusory symbol."
            ]
        }
    };

    function generateSpellFromIdea(idea) {
        idea = idea.toLowerCase();
        let config = { school: "Transmutation", damage: "Force", adjective: "Arcane", noun: "Energy" };
        for (const key in spellData.keywords) {
            if (idea.includes(key)) {
                config = { ...config, ...spellData.keywords[key] };
                break;
            }
        }

        let name = getRandom(spellData.templates.name).replace('{Adjective}', config.adjective).replace('{Noun}', config.noun).replace('{Damage}', config.damage);
        let level = idea.includes('cantrip') ? "Cantrip" : getRandom(spellData.templates.level);

        let description = getRandom(spellData.templates.description)
            .replace(/{Damage}/g, config.damage.toLowerCase())
            .replace('{Noun | plural}', config.noun + 's')
            .replace('{Noun}', config.noun)
            .replace('{Adjective}', config.adjective);
        
        if (level !== "Cantrip") {
            description += `\n\n<strong>At Higher Levels:</strong> When you cast this spell using a spell slot of ${parseInt(level[0]) + 1}th level or higher, the damage increases by 1d8 for each slot level above ${level[0]}.`;
        }

        // UPDATED: Now returns an HTML string for better formatting
        const spellHTML = `<pre><strong>Name:</strong> ${name}\n<strong>Level:</strong> ${level} ${config.school}\n<strong>Casting Time:</strong> ${getRandom(spellData.templates.castingTime)}\n<strong>Range:</strong> ${getRandom(spellData.templates.range)}\n<strong>Components:</strong> ${getRandom(spellData.templates.components)}\n<strong>Duration:</strong> ${getRandom(spellData.templates.duration)}\n\n${description}</pre>`;
        
        return spellHTML;
    }

    const spellIdeaInput = document.getElementById('spell-idea-input');
    const sendSpellIdeaBtn = document.getElementById('send-spell-idea');
    const chatHistory = document.getElementById('chat-history');
    const spellbookList = document.getElementById('spellbook-list');
    let savedSpells = JSON.parse(localStorage.getItem('dndSpellbook')) || [];
    let currentSpellHTML = "";

    function handleSpellGeneration() {
        const idea = spellIdeaInput.value.trim();
        if (idea) {
            currentSpellHTML = generateSpellFromIdea(idea);
            chatHistory.innerHTML = currentSpellHTML;
            
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save to Spellbook';
            saveButton.className = 'btn';
            saveButton.style.maxWidth = '200px';
            saveButton.style.margin = '15px auto';
            saveButton.onclick = () => {
                const nameMatch = currentSpellHTML.match(/<strong>Name:<\/strong> (.*?)\n/);
                const spellName = nameMatch ? nameMatch[1] : "Unnamed Spell";
                savedSpells.push({ name: spellName, html: currentSpellHTML });
                localStorage.setItem('dndSpellbook', JSON.stringify(savedSpells));
                renderSpellbook();
                alert(`${spellName} saved!`);
                saveButton.remove();
            };
            chatHistory.appendChild(saveButton);
            spellIdeaInput.value = '';
        }
    }

    sendSpellIdeaBtn.addEventListener('click', handleSpellGeneration);
    spellIdeaInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSpellGeneration();
    });

    function renderSpellbook() {
        spellbookList.innerHTML = '';
        savedSpells.forEach((spell, index) => {
            const li = document.createElement('li');
            li.textContent = spell.name || `Spell ${index + 1}`;
            li.onclick = () => {
                chatHistory.innerHTML = spell.html;
            };
            spellbookList.appendChild(li);
        });
    }

    // ======================= CAMPAIGN TRACKER LOGIC (Unchanged and Self-Contained) =========================
    // This script block is fully functional but omitted here for brevity. It would be included in the final file.
    function initializeCampaignTracker() { /* ... */ }
    function saveToActiveCampaign(contentType, content) { /* ... */ }

    // ======================= OTHER GENERATOR LOGIC (Unchanged and Self-Contained) ======================
    // This script block is fully functional but omitted here for brevity. It would be included in the final file.
    
</script>
</body>
</html>
