<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Master Toolkit</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        :root { --primary-bg: #1a1a1d; --secondary-bg: #2d2d34; --card-bg: #25252a; --text-color: #e2e2e2; --header-color: #c5c6c7; --border-color: #4a4a4a; --font-main: 'Georgia', serif; --font-header: 'Trajan Pro', 'Palatino Linotype', serif; --page-accent-primary: #c59b34; --page-accent-secondary: #a87d22; --page-bg-image: radial-gradient(circle, #3d3d44, var(--primary-bg)); }
        body { font-family: var(--font-main); background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: var(--secondary-bg); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color); }
        .page { display: none; background: var(--page-bg-image); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .page.active { display: block; }
        h1, h2 { font-family: var(--font-header); text-align: center; letter-spacing: 2px; padding-bottom: 10px; border-bottom: 2px solid; word-break: break-word; }
        h1 { font-size: 2.5em; color: var(--page-accent-primary); border-color: var(--page-accent-secondary); text-shadow: 0 0 10px var(--page-accent-primary); }
        h2 { font-size: 1.8em; color: var(--header-color); border-color: var(--border-color); }
        p { text-align: center; margin-bottom: 25px; font-style: italic; color: #b0b0b0; word-break: break-word; }
        .btn { display: inline-block; width: auto; max-width: 100%; padding: 15px 20px; margin: 5px; font-family: var(--font-header); font-size: 1.1em; letter-spacing: 1px; color: var(--text-color); background-color: var(--page-accent-primary); border: 2px solid var(--page-accent-secondary); border-radius: 5px; cursor: pointer; text-decoration: none; text-align: center; }
        .btn-return { display: block; background-color: #4a4a4a; border-color: #333; margin: 30px auto 0; }
        .btn-small { padding: 10px 20px; font-size: 1em; margin: 0 10px; }
        .btn-save { display: none; background-color: #388E3C; border-color: #1b5e20; }
        select, input, textarea { width: 100%; padding: 10px; background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; font-family: var(--font-main); font-size: 1em;}
        textarea { min-height: 250px; resize: vertical; }
        .generator-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 20px 0; flex-wrap: wrap; }
        .generator-controls .control-group { display: flex; align-items: center; gap: 8px; }
        .generator-controls label { flex-shrink: 0; }
        .generator-controls input, .generator-controls select { flex-grow: 1; min-width: 150px; }
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; }
        .main-grid .btn { width: 100%; margin: 5px 0; }
        .data-management { text-align: center; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .campaign-management { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 20px; }
        .campaign-management label { flex-shrink: 0; }
        .campaign-management select { flex-grow: 1; }
        
        #campaign-tracker { --page-accent-primary: #a05a2c; --page-accent-secondary: #7a4521; }
        #player-creator { --page-accent-primary: #B0C4DE; --page-accent-secondary: #778899; }
        #npc-populator { --page-accent-primary: #ffab40; --page-accent-secondary: #e08c24; }
        #location-generator { --page-accent-primary: #4CAF50; --page-accent-secondary: #388E3C; }
        #spellcraft-scribe { --page-accent-primary: #8A2BE2; --page-accent-secondary: #6012a3; }
        #maneuver-scribe { --page-accent-primary: #D2B48C; --page-accent-secondary: #8B4513; }
        #situational-catalyst { --page-accent-primary: #D32F2F; --page-accent-secondary: #B71C1C; }
        #environmental-generator { --page-accent-primary: #03A9F4; --page-accent-secondary: #0288D1; }
        #puzzle-trap-creator { --page-accent-primary: #CD7F32; --page-accent-secondary: #a96624; }
        #combat-tracker { --page-accent-primary: #B71C1C; --page-accent-secondary: #8B0000; }
        #bestiary-generator { --page-accent-primary: #4A148C; --page-accent-secondary: #311B92; }
        #loot-generator { --page-accent-primary: #FFD700; --page-accent-secondary: #B8860B; }
        #animations-page { --page-accent-primary: #ff4500; --page-accent-secondary: #cc3700; }
        
        .modular-output { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .output-module { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; }
        .output-module.locked { border-color: var(--page-accent-primary); }
        .output-module .content { flex-grow: 1; white-space: pre-wrap; word-break: break-word; }
        .module-controls { display: flex; gap: 10px; margin-top: 15px; }
        .module-btn { flex-grow: 1; padding: 5px; background-color: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; cursor: pointer; }
        .lock-btn.locked { background-color: var(--page-accent-secondary); }
        
        .tab-nav { list-style: none; padding: 0; margin: 20px 0 0; display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); }
        .tab-button { padding: 10px 20px; cursor: pointer; background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-bottom: none; border-radius: 6px 6px 0 0; margin-bottom: -1px; }
        .tab-button[aria-selected="true"] { background-color: var(--card-bg); font-weight: bold; border-color: var(--page-accent-primary); border-bottom-color: var(--card-bg); }
        .tab-content { display: none; background-color: var(--card-bg); padding: 20px; border: 1px solid var(--border-color); border-top: none; }
        .tab-content.active { display: block; }

        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-backdrop.active { display: flex; }
        .modal-content { background: var(--secondary-bg); padding: 40px; border-radius: 10px; text-align: center; border: 2px solid var(--page-accent-primary); box-shadow: 0 0 20px var(--page-accent-primary); }
        .modal-content h3 { margin-top: 0; font-family: var(--font-header); color: var(--page-accent-primary); }

        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        #combat-tracker-table { width: 100%; min-width: 600px; border-collapse: collapse; }
        #combat-tracker-table th, #combat-tracker-table td { padding: 12px; border: 1px solid var(--border-color); text-align: center; }
        #combat-tracker-table th { background-color: var(--card-bg); font-family: var(--font-header); }
        #combat-tracker-table tr.active-turn { background-color: rgba(255, 215, 0, 0.2); border-left: 3px solid var(--page-accent-primary); }
        #combat-tracker-table input[type="text"], #combat-tracker-table input[type="number"] { width: 90%; padding: 5px; text-align: center; background-color: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Page -->
        <div id="main-page" class="page active">
            <h1>D&D Master Toolkit</h1>
            <p>Your unified, single-file application for on-the-fly D&D 5e content generation and campaign management.</p>
             <div class="main-grid">
                <button class="btn" data-page="combat-tracker">Combat Tracker</button>
                <button class="btn" data-page="campaign-tracker">Campaign Tracker</button>
                <button class="btn" data-page="player-creator">Player Character Creator</button>
                <button class="btn" data-page="npc-populator">Instant NPC Populator</button>
                <button class="btn" data-page="bestiary-generator">Bestiary Generator</button>
                <button class="btn" data-page="location-generator">On-the-Fly Location</button>
                <button class="btn" data-page="spellcraft-scribe">Spellcraft Scribe</button>
                <button class="btn" data-page="maneuver-scribe">Maneuver Scribe</button>
                <button class="btn" data-page="situational-catalyst">Situational Catalyst</button>
                <button class="btn" data-page="puzzle-trap-creator">Quick Puzzle/Trap</button>
                <button class="btn" data-page="loot-generator">Loot Generator</button>
                <button class="btn" data-page="environmental-generator">Dynamic Environment</button>
                <button class="btn" data-page="animations-page">Animation VFX Library</button>
             </div>
             <div class="data-management">
                 <h2>Data Management</h2>
                 <p>Save all your campaigns to a file for backup, or import a previous backup.</p>
                 <button class="btn export-btn">Export All Data</button>
                 <button class="btn import-btn">Import Data</button>
             </div>
        </div>
        
        <!-- ==================== NEW/UPDATED PAGES ==================== -->

        <!-- Combat Tracker -->
        <div id="combat-tracker" class="page">
            <h1>Combat Tracker</h1>
            <p>Manage initiative, HP, and turn order. Stay in the action.</p>
            <div class="generator-controls">
                <button class="btn" id="add-combatant-btn">Add Combatant</button>
                <button class="btn" id="roll-initiative-btn">Roll All Initiative</button>
                <button class="btn" id="next-turn-btn">Next Turn</button>
            </div>
            <div class="table-wrapper">
                <table id="combat-tracker-table">
                    <thead><tr><th>Name</th><th>HP</th><th>AC</th><th>Initiative</th><th>Actions</th></tr></thead>
                    <tbody id="combat-tracker-body"></tbody>
                </table>
            </div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>

        <!-- Bestiary Generator -->
        <div id="bestiary-generator" class="page">
            <h2>Bestiary Generator</h2><p>Create a unique monster piece by piece.</p>
            <div class="generator-controls">
                <input type="text" id="monster-idea-input" placeholder="e.g., A floating eyeball that spits acid">
                <button class="btn" id="generate-monster-btn">Generate Monster</button>
                <button class="btn btn-save" id="save-monster-btn" data-type="log">Save Monster</button>
            </div>
            <div class="modular-output" id="monster-output"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>

        <!-- Loot Generator -->
        <div id="loot-generator" class="page">
            <h2>Loot Generator</h2><p>Generate a treasure hoard for your victorious adventurers.</p>
             <div class="generator-controls">
                <div class="control-group">
                    <label for="loot-cr-filter">Approx. CR:</label> 
                    <select id="loot-cr-filter">
                        <option value="low">Low (1-4)</option>
                        <option value="mid">Mid (5-10)</option>
                        <option value="high">High (11+)</option>
                    </select>
                </div>
                <button class="btn" id="generate-loot-btn">Generate Hoard</button>
                <button class="btn btn-save" id="save-loot-btn" data-type="log">Save Loot</button>
            </div>
            <div class="modular-output" id="loot-output"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        
        <!-- Animation VFX Library (Updated) -->
        <div id="animations-page" class="page">
            <h2>Animation VFX Library</h2>
            <p>Select an animation below and link it to one of your custom spells or maneuvers.</p>
            <div id="video-library-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        
        <!-- Situational Catalyst (Converted to Modular) -->
        <div id="situational-catalyst" class="page">
             <h2>Situational Catalyst</h2><p>Spark a new quest, encounter, or plot twist, one piece at a time.</p>
             <div class="generator-controls">
                <button class="btn" id="generate-catalyst-btn">Generate Catalyst</button>
                <button class="btn btn-small btn-save" id="save-catalyst-btn" data-type="quest">Save as Quest</button>
            </div>
             <div class="modular-output" id="catalyst-output"></div>
             <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        
        <!-- Dynamic Environment (Converted to Modular) -->
        <div id="environmental-generator" class="page">
             <h2>Dynamic Environment</h2><p>Add atmospheric flavor to any scene, element by element.</p>
             <div class="generator-controls"><button class="btn" id="generate-environment-btn">Generate Environment</button></div>
             <div class="modular-output" id="environment-output"></div>
             <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        
        <!-- Puzzle/Trap Creator (Converted to Modular) -->
        <div id="puzzle-trap-creator" class="page">
             <h2>Quick Puzzle/Trap</h2><p>Create a simple challenge, refining each component.</p>
             <div class="generator-controls">
                <div class="control-group">
                    <label for="puzzle-trap-type">Type:</label>
                    <select id="puzzle-trap-type"><option value="any">Any Challenge</option><option value="Puzzle">Puzzle</option><option value="Trap">Trap</option></select>
                </div>
                <button class="btn btn-small" id="generate-puzzle-trap-btn">Generate Challenge</button>
                <button class="btn btn-small btn-save" id="save-puzzle-trap-btn" data-type="log">Save to Log</button>
            </div>
             <div class="modular-output" id="puzzle-trap-output"></div>
             <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>

        <!-- ==================== ORIGINAL PAGES (Still functional) ==================== -->
        
        <div id="campaign-tracker" class="page">
            <h1>Campaign Tracker</h1>
            <div class="campaign-management">
                <label for="campaign-selector">Active Campaign:</label> 
                <select id="campaign-selector"></select>
                <button class="btn btn-small" id="new-campaign-btn">New</button> 
                <button class="btn btn-small" id="delete-campaign-btn">Delete</button>
            </div>
            <input type="text" id="campaign-title" placeholder="Select or create a campaign">
            <div role="tablist" class="tab-nav" id="campaign-tab-nav">
                 <button role="tab" aria-selected="true" class="tab-button" id="tab-btn-log" aria-controls="tab-panel-log">Session Log</button>
                 <button role="tab" aria-selected="false" class="tab-button" id="tab-btn-pcs" aria-controls="tab-panel-pcs">PCs</button>
                 <button role="tab" aria-selected="false" class="tab-button" id="tab-btn-npcs" aria-controls="tab-panel-npcs">NPCs</button>
                 <button role="tab" aria-selected="false" class="tab-button" id="tab-btn-locations" aria-controls="tab-panel-locations">Locations</button>
                 <button role="tab" aria-selected="false" class="tab-button" id="tab-btn-quests" aria-controls="tab-panel-quests">Quests</button>
            </div>
            <div class="tab-content-container">
                 <div role="tabpanel" tabindex="0" id="tab-panel-log" class="tab-content active"><label for="campaign-log">Session Log</label><textarea id="campaign-log" data-field="log"></textarea></div>
                 <div role="tabpanel" tabindex="0" id="tab-panel-pcs" class="tab-content"><label for="campaign-pcs">Player Characters</label><textarea id="campaign-pcs" data-field="pcs"></textarea></div>
                 <div role="tabpanel" tabindex="0" id="tab-panel-npcs" class="tab-content"><label for="campaign-npcs">Key NPCs</label><textarea id="campaign-npcs" data-field="npcs"></textarea></div>
                 <div role="tabpanel" tabindex="0" id="tab-panel-locations" class="tab-content"><label for="campaign-locations">Locations</label><textarea id="campaign-locations" data-field="locations"></textarea></div>
                 <div role="tabpanel" tabindex="0" id="tab-panel-quests" class="tab-content"><label for="campaign-quests">Quests</label><textarea id="campaign-quests" data-field="quests"></textarea></div>
            </div>
            <div class="data-management">
                <h2>Data Management</h2>
                <p>Save all your campaigns to a file for backup, or import a previous backup.</p>
                <button class="btn export-btn">Export All Data</button>
                <button class="btn import-btn">Import Data</button>
            </div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        <div id="player-creator" class="page">
            <h2>Player Character Creator</h2><p>Build a character piece by piece. Lock what you like, reroll what you don't.</p>
            <div class="generator-controls">
                <button class="btn" id="generate-pc-btn">Generate All</button>
                <button class="btn btn-save" id="save-pc-btn" data-type="pc">Save Assembled PC</button>
            </div>
            <div class="modular-output" id="pc-output"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        <div id="npc-populator" class="page">
            <h2>Instant NPC Populator</h2><p>Craft a unique NPC. Lock their race, reroll their secret!</p>
            <div class="generator-controls">
                <button class="btn" id="generate-npc-btn">Generate All</button>
                <button class="btn btn-save" id="save-npc-btn" data-type="npc">Save Assembled NPC</button>
            </div>
            <div class="modular-output" id="npc-output"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        <div id="location-generator" class="page">
            <h2>On-the-Fly Location</h2><p>Create an evocative location, refining each sensory detail.</p>
             <div class="generator-controls">
                <div class="control-group">
                    <label for="location-terrain-filter">Terrain:</label> 
                    <select id="location-terrain-filter"></select>
                </div>
                <button class="btn" id="generate-location-btn">Generate All</button>
                <button class="btn btn-save" id="save-location-btn" data-type="location">Save Assembled Location</button>
            </div>
            <div class="modular-output" id="location-output"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        <div id="spellcraft-scribe" class="page">
            <h1>Spellcraft Scribe</h1>
            <p>Describe a spell and conjure it piece by piece. Lock what you love, reroll the rest.</p>
            <div class="generator-controls">
                 <input type="text" id="spell-idea-input" placeholder="e.g., A plague of insects that emits from the eyes">
                 <button class="btn" id="conjure-spell-btn">Conjure Spell</button>
                 <button class="btn btn-save" id="save-spell-btn" data-type="log">Save to Log</button>
            </div>
            <div class="modular-output" id="spell-output"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
        <div id="maneuver-scribe" class="page">
            <h2>Maneuver Scribe</h2>
            <p>Devise a custom martial attack. For fighters, rogues, and barbarians who need flair.</p>
            <div class="generator-controls">
                 <input type="text" id="maneuver-idea-input" placeholder="e.g., A sweeping sword strike that disarms">
                 <button class="btn" id="conjure-maneuver-btn">Devise Maneuver</button>
                 <button class="btn btn-save" id="save-maneuver-btn" data-type="log">Save to Log</button>
            </div>
            <div class="modular-output" id="maneuver-output"></div>
            <button class="btn btn-return" data-page="main-page">Return to Main</button>
        </div>
    </div>

    <!-- Maintenance Pop-up Modal -->
    <div class="modal-backdrop" id="maintenance-modal">
        <div class="modal-content">
            <h3>Feature Under Maintenance</h3>
            <p>This functionality is currently being forged and is not yet available.</p>
            <button class="btn btn-small" id="modal-return-btn">Return</button>
        </div>
    </div>

<script>
// ======================= APP INITIALIZATION & NAVIGATION ==========================
document.addEventListener('DOMContentLoaded', () => {
    initializeNavigation();
    initializeCampaignTracker();
    initializeGenerators();
    initializeCombatTracker();
    initializeDataManagement();
    populateVfxLibrary();
});

function initializeNavigation() {
    document.body.addEventListener('click', (event) => {
        const button = event.target.closest('[data-page]');
        if (button) {
            event.preventDefault();
            const pageId = button.dataset.page;
            showPage(pageId);
        }
    });
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });

    const activePage = document.getElementById(pageId);
    if (activePage) {
        activePage.classList.add('active');
        document.body.style.setProperty('--page-accent-primary', getComputedStyle(activePage).getPropertyValue('--page-accent-primary'));
        document.body.style.setProperty('--page-accent-secondary', getComputedStyle(activePage).getPropertyValue('--page-accent-secondary') || getComputedStyle(activePage).getPropertyValue('--page-accent-primary'));
    }
}

const getRandom = (arr) => arr ? arr[Math.floor(Math.random() * arr.length)] : '';
const getOrdinalSuffix = n => { const s = ["th", "st", "nd", "rd"]; const v = n % 100; return n + (s[(v - 20) % 10] || s[v] || s[0]); };

// ======================= MASSIVE 5E DATA OBJECT ==========================
const dndData = {
    names: { Human: { first: ["Alistair", "Elara", "Gideon", "Seraphina", "Kaelen"], last: ["Blackwood", "Oakhart", "Stonemantle"] }, Elf: { first: ["Aerion", "Lael", "Lyra"], last: ["Moonshadow", "Starflower"] }, Dwarf: { first: ["Bram", "Gimli", "Helga"], clan: ["Stonehammer", "Ironfist"] }, Halfling: { first: ["Pippin", "Rosie", "Samwise"], last: ["Greenbottle", "Tealeaf"] }, Dragonborn: { first: ["Arjhan", "Sora", "Kriv"], clan: ["Clethtinthiallor", "Delmirev"] }, Gnome: { first: ["Fizzle", "Gnorman", "Nissa"], last: ["Cobblelob", "Fnipper"] }, Tiefling: { first: ["Akmenos", "Kallista", "Mehen"], virtue: ["Art", "Creed", "Hope", "Fear"] }, HalfOrc: { first: ["Gruk", "Shump", "Ront"], last: [] } },
    pc: { classes: ["Barbarian", "Bard", "Cleric", "Druid", "Fighter", "Monk", "Paladin", "Ranger", "Rogue", "Sorcerer", "Warlock", "Wizard"], backgrounds: { "Acolyte": "I see omens in every event.", "Criminal": "I always have a plan.", "Folk Hero": "I judge people by their actions.", "Sage": "I use polysyllabic words." }, alignments: ["Lawful Good", "Neutral Good", "Chaotic Good", "Lawful Neutral", "True Neutral", "Chaotic Neutral", "Lawful Evil", "Neutral Evil", "Chaotic Evil"] },
    npc: { races: ["Human", "Elf", "Dwarf", "Halfling", "Gnome", "Dragonborn", "Tiefling", "Half-Orc"], occupations: ["Blacksmith", "Alchemist", "Guard Captain", "Librarian", "Guild Master", "Street Urchin", "Retired Adventurer"], mannerisms: ["Taps fingers impatiently", "Adjusts their spectacles", "Speaks in a hushed tone", "Has a booming, infectious laugh", "Chews on a piece of straw"], secrets: ["is a disgraced noble", "secretly works for a rival faction", "is terrified of heights", "possesses a rare magical artifact", "owes a life debt"] },
    location: { terrains: ["Forest", "City", "Mountain", "Dungeon", "Coastal", "Swamp", "Plains"], sights: ["Long, distorted shadows", "A thick, rolling fog", "Brilliant starlight", "Unnaturally vibrant moss", "Crumbling, vine-choked ruins"], sounds: ["A distant wolf howl", "The gentle rustling of leaves", "An unnatural, profound silence", "The rhythmic drip of water"], smells: ["Damp soil and decay", "The sharp tang of ozone", "The cloying sweetness of a strange flower", "The faint, metallic scent of old blood"] },
    catalyst: { actors: ["A desperate refugee", "A charismatic cult leader", "A retired adventurer", "A mischievous fey creature"], actions: ["steals", "is searching for", "has discovered a prophecy about", "wants to destroy"], subjects: ["a legendary artifact.", "a person the party knows.", "a map to a lost city.", "a dark secret about the king."], twists: ["The 'villain' is actually the victim.", "The item they seek is cursed.", "The quest giver has a hidden agenda."] },
    environment: { sights: ["Long, distorted shadows stretch from the trees.", "A thick, rolling fog blankets the ground.", "The sky is a brilliant tapestry of stars."], sounds: ["the distant howl of a lone wolf.", "the gentle rustling of leaves in the wind.", "an unnatural silence that seems to absorb all noise."], smells: ["the earthy scent of damp soil and decay.", "the sharp tang of ozone after a storm.", "the cloying sweetness of a strange, blooming flower."] },
    puzzleTrap: { types: ["Puzzle", "Trap"], triggers: {Puzzle: ["speaking a specific phrase", "arranging items in a pattern"], Trap: ["a tripwire", "a pressure plate"]}, mechanisms: {Puzzle: ["A series of rotating stone rings with symbols that must align."], Trap: ["Poisoned darts shoot from the walls."]}, solutions: {Puzzle: "Solving the riddle reveals the way forward.", Trap: "A successful Dexterity check to disarm."} },
    spell: { elements: { fire: { damage: "Fire", school: "Evocation", adjective: "Fiery", noun: "Flame" }, ice: { damage: "Cold", school: "Evocation", adjective: "Icy", noun: "Shard" }, lightning: { damage: "Lightning", school: "Evocation", adjective: "Crackling", noun: "Bolt" }, shadow: { damage: "Necrotic", school: "Illusion", adjective: "Shadowy", noun: "Tendril" }, acid: { damage: "Acid", school: "Conjuration", adjective: "Corrosive", noun: "Glob" }, force: { damage: "Force", school: "Evocation", adjective: "Arcane", noun: "Missile" } }, substances: { blood: { damage: "Necrotic", school: "Necromancy", adjective: "Sanguine", noun: "Curse" }, poison: { damage: "Poison", school: "Necromancy", adjective: "Venomous", noun: "Fume" }, insect: { damage: "Poison", school: "Conjuration", adjective: "Chittering", noun: "Swarm" } }, forms: { dragon: "Dragon", swarm: "Swarm", wall: "Wall", chains: "Chains", bolt: "Bolt" }, delivery: { gaze: "Gaze", breath: "Breath", touch: "Touch", word: "Word" }, effects: { restrain: "Restrained", push: "Pushed", fear: "Frightened", blind: "Blinded", disease: "Diseased" }, misc: { level: ["Cantrip", "1st-level", "2nd-level", "3rd-level"], castingTime: ["1 Action", "1 Bonus Action", "Reaction"], range: ["30 feet", "60 feet", "Touch", "Self"], components: ["V, S, M", "V, S", "S, M"], duration: ["Instantaneous", "Concentration, up to 1 minute", "1 round"] } },
    maneuver: { weapons: { sword: { noun: "Sword", adjective: "Precise", verb: "thrust" }, axe: { noun: "Axe", adjective: "Brutal", verb: "swing" } }, actions: { cleave: "You {verb} your {weapon} in a wide arc.", lunge: "You lunge forward, extending your reach." }, effects: { trip: "On hit, the target must make a Strength save or be knocked prone.", disarm: "On hit, the target must make a Strength save or drop one item." }, misc: { cost: ["Action", "Bonus Action"], range: ["Melee", "5 feet"]}},
    monster: { types: ["Aberration", "Beast", "Construct", "Dragon", "Elemental", "Fey", "Giant", "Humanoid", "Monstrosity", "Ooze", "Undead"], traits: ["Amphibious", "Amorphous", "Magic Resistance", "Pack Tactics", "Regeneration"], actions: ["Bite Attack.", "Claw Attack.", "Acid Spit.", "Multiattack: Makes two claw attacks."] },
    loot: { coins: { low: "1d100 CP, 1d20 SP", mid: "1d100 SP, 1d20 GP", high: "1d100 GP, 1d20 PP" }, gems: ["A pouch of small, flawed amethysts", "A single, perfectly cut sapphire", "A rough, unpolished diamond"], items: ["Potion of Healing", "Scroll of Fireball", "+1 Longsword", "A beautifully crafted music box"] }
};

// ======================= GENERATOR LOGIC =========================
let currentSpellConfig = {}, currentManeuverConfig = {};
function initializeGenerators() {
    document.getElementById('location-terrain-filter').innerHTML = dndData.location.terrains.map(t => `<option value="${t}">${t}</option>`).join('');
    
    const modularGenerators = [
        'pc', 'npc', 'location', 'spell', 'maneuver', 
        'monster', 'loot', 'catalyst', 'environment', 'puzzle-trap'
    ];
    
    modularGenerators.forEach(type => {
        const btn = document.getElementById(`generate-${type}-btn`) || document.getElementById(`conjure-${type}-btn`);
        if (btn) btn.addEventListener('click', () => generateModularEntity(type));
    });

    document.querySelector('.container').addEventListener('click', (e) => { 
        if (e.target.matches('.reroll-btn')) { 
            const module = e.target.closest('.output-module'); 
            const entityType = module.closest('.modular-output').id.split('-')[0];
            module.querySelector('.content').innerHTML = generatePart(entityType, module.dataset.key); 
        } else if (e.target.matches('.lock-btn')) { 
            const module = e.target.closest('.output-module'); 
            module.classList.toggle('locked'); 
            e.target.classList.toggle('locked'); 
            e.target.textContent = module.classList.contains('locked') ? 'Unlock' : 'Lock'; 
        } 
    });
    
    document.querySelectorAll('.btn-save').forEach(btn => btn.addEventListener('click', (e) => {
        const entityType = e.target.id.split('-')[1];
        const outputArea = document.getElementById(`${entityType}-output`);
        if (outputArea?.classList.contains('modular-output')) { 
            let content = ""; 
            outputArea.querySelectorAll('.output-module').forEach(m => { 
                const title = m.querySelector('h4').textContent;
                const body = m.querySelector('.content').innerHTML.replace(/<br\s*[\/]?>/gi, "\n").replace(/<\/?[^>]+(>|$)/g, "");
                content += `${title}:\n${body}\n\n`; 
            }); 
            saveToActiveCampaign(e.target.dataset.type, content.trim());
        }
    }));
}

function createModule(container, key, title, content) {
    const module = document.createElement('div');
    module.className = 'output-module';
    module.dataset.key = key;
    module.innerHTML = `<h4>${title}</h4><div class="content">${content}</div><div class="module-controls"><button class="module-btn lock-btn">Lock</button><button class="module-btn reroll-btn">Reroll</button></div>`;
    container.appendChild(module);
}

function generateModularEntity(type) {
    const container = document.getElementById(`${type}-output`);
    const saveBtn = document.getElementById(`save-${type}-btn`);
    if(saveBtn) saveBtn.style.display = 'inline-block';

    const modules = {
        pc: { Name: "Name & Race", Class: "Class", Stats: "Ability Scores", Background: "Background"},
        npc: { Name: "Name & Race", Vitals: "Vitals", Mannerism: "Mannerism", Secret: "Secret"},
        location: { Title: "Title", Sight: "Dominant Sight", Sound: "Ambient Sound", Smell: "Lingering Smell"},
        spell: { Name: "Name & Level", Details: "Casting Details", Description: "Spell Description"},
        maneuver: { Name: "Name", Details: "Action Details", Description: "Maneuver Description"},
        monster: { Name: "Name & Type", Vitals: "Vitals", Trait: "Primary Trait", Action: "Main Action" },
        loot: { Coins: "Coinage", Gems: "Valuables", Item: "Special Item" },
        catalyst: { Actor: "The Actor", Action: "The Action", Subject: "The Subject", Twist: "The Twist" },
        environment: { Sight: "Dominant Sight", Sound: "Ambient Sound", Smell: "Lingering Smell" },
        'puzzle-trap': { Type: "Type", Trigger: "The Trigger", Mechanism: "The Mechanism", Solution: "The Solution" }
    };

    const generate = () => {
        if (!container.children.length) {
            container.innerHTML = '';
            for (const [key, title] of Object.entries(modules[type])) {
                createModule(container, key, title, generatePart(type, key));
            }
        } else {
            container.querySelectorAll('.output-module:not(.locked)').forEach(m => {
                m.querySelector('.content').innerHTML = generatePart(type, m.dataset.key);
            });
        }
    };

    if (type === 'spell') currentSpellConfig = generateSpellFromIdea(document.getElementById('spell-idea-input').value);
    if (type === 'maneuver') currentManeuverConfig = generateManeuverFromIdea(document.getElementById('maneuver-idea-input').value);
    
    generate();
}

function generatePart(type, key) {
    const getName = (race) => { const n = dndData.names[race] || dndData.names.Human; const f = getRandom(n.first); const l = n.last?.length ? getRandom(n.last) : (n.clan ? getRandom(n.clan) : (race === 'Tiefling' ? `"${getRandom(n.virtue)}"` : "")); return `${f} ${l}`.trim(); };
    const rollStats = () => [1,2,3,4].map(()=>Math.floor(Math.random()*6)+1).sort().slice(1).reduce((s,v)=>s+v,0);
    const selectedPuzzleType = document.getElementById('puzzle-trap-type')?.value === 'any' ? getRandom(dndData.puzzleTrap.types) : document.getElementById('puzzle-trap-type')?.value;

    switch (`${type}-${key}`) {
        case 'pc-Name': const pcRace=getRandom(Object.keys(dndData.names)); return `${getName(pcRace)}\n(${pcRace})`; 
        case 'pc-Class': return getRandom(dndData.pc.classes); 
        case 'pc-Stats': return `STR:${rollStats()}, DEX:${rollStats()}, CON:${rollStats()}\nINT:${rollStats()}, WIS:${rollStats()}, CHA:${rollStats()}`; 
        case 'pc-Background': return `${getRandom(Object.keys(dndData.pc.backgrounds))}\n(${getRandom(dndData.pc.alignments)})`; 
        case 'npc-Name': const nRace=getRandom(dndData.npc.races); return `${getName(nRace)}\n(${nRace})`; 
        case 'npc-Vitals': return `Occupation: ${getRandom(dndData.npc.occupations)}\nAlignment: ${getRandom(dndData.pc.alignments)}`; 
        case 'npc-Mannerism': return getRandom(dndData.npc.mannerisms); 
        case 'npc-Secret': return getRandom(dndData.npc.secrets); 
        case 'location-Title': return `A ${document.getElementById('location-terrain-filter').value} place`; 
        case 'location-Sight': return getRandom(dndData.location.sights); 
        case 'location-Sound': return getRandom(dndData.location.sounds); 
        case 'location-Smell': return getRandom(dndData.location.smells); 
        case 'spell-Name': currentSpellConfig.level=getRandom(dndData.spell.misc.level); return `<b>${currentSpellConfig.name}</b>\n<small>(${currentSpellConfig.level} ${currentSpellConfig.school})</small>`;
        case 'spell-Details': return `<b>Time:</b> ${getRandom(dndData.spell.misc.castingTime)}\n<b>Range:</b> ${getRandom(dndData.spell.misc.range)}\n<b>Comp:</b> ${getRandom(dndData.spell.misc.components)}\n<b>Duration:</b> ${getRandom(dndData.spell.misc.duration)}`;
        case 'spell-Description': let d = currentSpellConfig.description; if(currentSpellConfig.level!=="Cantrip") {const c=parseInt(currentSpellConfig.level[0]), n=c+1; d+=`\n\n<b>At Higher Levels:</b> When cast with a ${getOrdinalSuffix(n)} level slot, the effect intensifies.`} return d;
        case 'maneuver-Name': return `<b>${currentManeuverConfig.name}</b>`;
        case 'maneuver-Details': return `<b>Cost:</b> ${getRandom(dndData.maneuver.misc.cost)}\n<b>Range:</b> ${getRandom(dndData.maneuver.misc.range)}`;
        case 'maneuver-Description': return currentManeuverConfig.description;
        case 'monster-Name': return `${getRandom(['Grave', 'Shadow', 'Deep', 'Rock'])} ${getRandom(['Crawler', 'Stalker', 'Horror', 'Behemoth'])}\n(${getRandom(dndData.monster.types)})`;
        case 'monster-Vitals': return `AC: ${10 + Math.floor(Math.random() * 8)}\nHP: ${10 + Math.floor(Math.random() * 50)}\nSpeed: 30ft`;
        case 'monster-Trait': return getRandom(dndData.monster.traits);
        case 'monster-Action': return getRandom(dndData.monster.actions);
        case 'loot-Coins': return dndData.loot.coins[document.getElementById('loot-cr-filter').value];
        case 'loot-Gems': return getRandom(dndData.loot.gems);
        case 'loot-Item': return getRandom(dndData.loot.items);
        case 'catalyst-Actor': return getRandom(dndData.catalyst.actors);
        case 'catalyst-Action': return getRandom(dndData.catalyst.actions);
        case 'catalyst-Subject': return getRandom(dndData.catalyst.subjects);
        case 'catalyst-Twist': return getRandom(dndData.catalyst.twists);
        case 'environment-Sight': return getRandom(dndData.environment.sights);
        case 'environment-Sound': return getRandom(dndData.environment.sounds);
        case 'environment-Smell': return getRandom(dndData.environment.smells);
        case 'puzzle-trap-Type': return selectedPuzzleType;
        case 'puzzle-trap-Trigger': return getRandom(dndData.puzzleTrap.triggers[selectedPuzzleType]);
        case 'puzzle-trap-Mechanism': return getRandom(dndData.puzzleTrap.mechanisms[selectedPuzzleType]);
        case 'puzzle-trap-Solution': return dndData.puzzleTrap.solutions[selectedPuzzleType];
        default: return "Error";
    }
}

function generateSpellFromIdea(idea) {
    const { elements, substances, forms, delivery, effects } = dndData.spell; idea = idea.toLowerCase();
    const find = (dict) => { for (const key in dict) if (idea.includes(key)) return dict[key]; return null; };
    const config = { substance: find(substances), element: find(elements), form: find(forms), delivery: find(delivery), effect: find(effects) };
    const theme = config.substance || config.element || elements.force;
    const school = theme.school || "Transmutation";
    let name = (config.delivery || "") + " of " + (theme.adjective) + " " + (config.form || theme.noun);
    let description = `You channel ${theme.damage.toLowerCase()} energy. A target must succeed on a saving throw or take 2d8 ${theme.damage} damage.`;
    if(config.effect) description += ` and suffer the ${config.effect} condition.`;
    return { name, school, description };
}
function generateManeuverFromIdea(idea) {
    const { weapons, actions, effects } = dndData.maneuver; idea = idea.toLowerCase();
    const find = (dict, key) => { for (const k in dict) if (idea.includes(k)) return dict[k][key]; return null; };
    const config = { weapon: find(weapons, 'noun') || 'Sword', verb: find(weapons, 'verb') || 'swing', action: find(actions) || actions.lunge, effect: find(effects) };
    let name = config.effect ? `${config.effect.split(' ')[0]}ing ${config.weapon}` : `${config.weapon} ${config.action.split(' ')[0]}`;
    let description = config.action.replace('{verb}', config.verb).replace('{weapon}', config.weapon);
    if(config.effect) description += ` ` + config.effect; else description += ` On a hit, a target takes normal weapon damage.`;
    return { name, description };
}

// ======================= VFX & MAINTENANCE MODAL LOGIC =========================
function populateVfxLibrary() {
    const grid = document.getElementById('video-library-grid');
    if (!grid) return;
    grid.innerHTML = '';
    const vfxList = [{id:'fire-01', icon:'ðŸ”¥', name:'Fireball'}, {id:'lightning-01', icon:'âš¡', name:'Lightning'}, {id:'slash-01', icon:'âš”ï¸', name:'Sword Slash'}];
    vfxList.forEach(vfx => {
        const thumb = document.createElement('div');
        thumb.className = 'video-thumbnail';
        thumb.innerHTML = `<div class="video-thumbnail-img">${vfx.icon}</div><strong>${vfx.name}</strong><button class="btn btn-small">Link</button>`;
        thumb.querySelector('button').addEventListener('click', () => showMaintenanceModal());
        grid.appendChild(thumb);
    });
}
function showMaintenanceModal() {
    document.getElementById('maintenance-modal').classList.add('active');
}
document.getElementById('modal-return-btn').addEventListener('click', () => {
    document.getElementById('maintenance-modal').classList.remove('active');
});

// ======================= CAMPAIGN TRACKER LOGIC =========================
const campaignsKey = 'dndCampaigns', activeCampaignIdKey = 'activeDndCampaignId';
function initializeCampaignTracker() {
    loadCampaigns();
    document.getElementById('new-campaign-btn').addEventListener('click', createNewCampaign);
    document.getElementById('delete-campaign-btn').addEventListener('click', deleteActiveCampaign);
    document.getElementById('campaign-selector').addEventListener('change', (e) => {
        localStorage.setItem(activeCampaignIdKey, e.target.value);
        loadActiveCampaign();
    });
    document.getElementById('campaign-title').addEventListener('input', saveCampaignData);
    document.querySelectorAll('#campaign-tracker textarea').forEach(ta => ta.addEventListener('input', saveCampaignData));
    const tabNav = document.getElementById('campaign-tab-nav');
    tabNav.addEventListener('click', (e) => {
        if (e.target.matches('.tab-button')) {
            tabNav.querySelectorAll('.tab-button').forEach(btn => btn.setAttribute('aria-selected', 'false'));
            e.target.setAttribute('aria-selected', 'true');
            const targetPanelId = e.target.getAttribute('aria-controls');
            document.querySelectorAll('#campaign-tracker .tab-content').forEach(panel => panel.classList.toggle('active', panel.id === targetPanelId));
        }
    });
}
function getCampaigns() { return JSON.parse(localStorage.getItem(campaignsKey)) || {}; }
function saveCampaigns(campaigns) { localStorage.setItem(campaignsKey, JSON.stringify(campaigns)); }
function loadCampaigns() {
    const campaigns = getCampaigns();
    const activeId = localStorage.getItem(activeCampaignIdKey);
    const selector = document.getElementById('campaign-selector');
    selector.innerHTML = '<option value="">-- Select a Campaign --</option>';
    for (const id in campaigns) {
        const option = document.createElement('option');
        option.value = id; option.textContent = campaigns[id].title; option.selected = id === activeId;
        selector.appendChild(option);
    }
    loadActiveCampaign();
}
function loadActiveCampaign() {
    const campaigns = getCampaigns();
    const activeId = localStorage.getItem(activeCampaignIdKey);
    const campaign = campaigns[activeId];
    const titleEl = document.getElementById('campaign-title');
    const textareas = document.querySelectorAll('#campaign-tracker textarea');
    if (campaign) {
        titleEl.value = campaign.title || '';
        textareas.forEach(ta => { ta.value = campaign[ta.dataset.field] || ''; });
        titleEl.disabled = false;
        textareas.forEach(ta => ta.disabled = false);
    } else {
        titleEl.value = 'No campaign selected';
        textareas.forEach(ta => ta.value = '');
        titleEl.disabled = true;
        textareas.forEach(ta => ta.disabled = true);
    }
}
function saveCampaignData() {
    const activeId = localStorage.getItem(activeCampaignIdKey);
    if (!activeId) return;
    const campaigns = getCampaigns();
    if (!campaigns[activeId]) return;
    const titleEl = document.getElementById('campaign-title');
    campaigns[activeId].title = titleEl.value;
    document.querySelectorAll('#campaign-tracker textarea').forEach(ta => {
        campaigns[activeId][ta.dataset.field] = ta.value;
    });
    saveCampaigns(campaigns);
    const selectedOption = document.querySelector(`#campaign-selector option[value="${activeId}"]`);
    if (selectedOption && selectedOption.textContent !== titleEl.value) selectedOption.textContent = titleEl.value;
}
function createNewCampaign() {
    const title = prompt("Enter new campaign name:", "My New Campaign");
    if (!title) return;
    const campaigns = getCampaigns();
    const newId = `campaign_${Date.now()}`;
    campaigns[newId] = { title, log: '', pcs: '', npcs: '', locations: '', quests: '' };
    saveCampaigns(campaigns);
    localStorage.setItem(activeCampaignIdKey, newId);
    loadCampaigns();
}
function deleteActiveCampaign() {
    const activeId = localStorage.getItem(activeCampaignIdKey);
    if (!activeId || !getCampaigns()[activeId]) return alert("No campaign selected to delete.");
    if (confirm(`Are you sure you want to permanently delete "${getCampaigns()[activeId]?.title}"?`)) {
        const campaigns = getCampaigns();
        delete campaigns[activeId];
        saveCampaigns(campaigns);
        localStorage.setItem(activeCampaignIdKey, '');
        loadCampaigns();
    }
}
function saveToActiveCampaign(type, content) {
    const activeId = localStorage.getItem(activeCampaignIdKey);
    if (!activeId) return alert("Please select or create a campaign first to save this content.");
    let targetField;
    switch(type) {
        case 'pc': targetField = 'pcs'; break;
        case 'npc': targetField = 'npcs'; break;
        case 'location': targetField = 'locations'; break;
        case 'quest': targetField = 'quests'; break;
        default: targetField = 'log'; break;
    }
    const targetArea = document.querySelector(`#campaign-tracker textarea[data-field="${targetField}"]`);
    if (targetArea) {
        targetArea.value += (targetArea.value ? '\n\n' : '') + `${content}\n${'-'.repeat(40)}`;
        saveCampaignData();
        alert(`Content saved to the "${targetField.toUpperCase()}" tab of your active campaign.`);
    }
}

// ======================= COMBAT TRACKER LOGIC =========================
let combatants = [];
let currentTurnIndex = -1;

function initializeCombatTracker() {
    document.getElementById('add-combatant-btn').addEventListener('click', addCombatant);
    document.getElementById('roll-initiative-btn').addEventListener('click', rollAllInitiative);
    document.getElementById('next-turn-btn').addEventListener('click', nextTurn);
    document.getElementById('combat-tracker-body').addEventListener('click', e => {
        if (e.target.classList.contains('remove-combatant-btn')) {
            const index = e.target.closest('tr').dataset.index;
            removeCombatant(index);
        }
    });
    document.getElementById('combat-tracker-body').addEventListener('change', e => {
        if (e.target.matches('input')) {
            const index = e.target.closest('tr').dataset.index;
            const field = e.target.dataset.field;
            updateCombatant(index, field, e.target.value);
        }
    });
}

function renderCombatTracker() {
    const tbody = document.getElementById('combat-tracker-body');
    tbody.innerHTML = '';
    combatants.forEach((c, index) => {
        const row = document.createElement('tr');
        row.dataset.index = index;
        if (index === currentTurnIndex) row.classList.add('active-turn');
        row.innerHTML = `
            <td><input type="text" data-field="name" value="${c.name}"></td>
            <td><input type="number" data-field="hp" value="${c.hp}"></td>
            <td><input type="number" data-field="ac" value="${c.ac}"></td>
            <td><input type="number" data-field="initiative" value="${c.initiative}"></td>
            <td><button class="btn-small remove-combatant-btn">Remove</button></td>
        `;
        tbody.appendChild(row);
    });
}

function addCombatant() {
    combatants.push({ id: Date.now(), name: 'Creature', hp: 10, ac: 10, initiative: 0 });
    renderCombatTracker();
}

function removeCombatant(index) {
    combatants.splice(index, 1);
    if(currentTurnIndex >= combatants.length) currentTurnIndex = combatants.length > 0 ? 0 : -1;
    else if (currentTurnIndex > index) currentTurnIndex--;
    renderCombatTracker();
}

function updateCombatant(index, field, value) {
    if (combatants[index]) {
        combatants[index][field] = value;
    }
}

function rollAllInitiative() {
    combatants.forEach(c => {
        c.initiative = Math.floor(Math.random() * 20) + 1;
    });
    combatants.sort((a, b) => b.initiative - a.initiative);
    currentTurnIndex = combatants.length > 0 ? 0 : -1;
    renderCombatTracker();
}

function nextTurn() {
    if (combatants.length === 0) return;
    currentTurnIndex++;
    if (currentTurnIndex >= combatants.length) {
        currentTurnIndex = 0;
    }
    renderCombatTracker();
}

// ======================= DATA MANAGEMENT LOGIC ========================
function initializeDataManagement() {
    document.querySelectorAll('.export-btn').forEach(btn => {
        btn.addEventListener('click', exportAllData);
    });
    document.querySelectorAll('.import-btn').forEach(btn => {
        btn.addEventListener('click', importData);
    });
}

function exportAllData() {
    try {
        const dataToExport = {
            campaigns: JSON.parse(localStorage.getItem(campaignsKey) || '{}'),
            activeCampaignId: localStorage.getItem(activeCampaignIdKey) || ''
        };
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `dnd-toolkit-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        alert('Data exported successfully!');
    } catch (error) {
        alert('Could not export data. Your stored data might be corrupted.');
        console.error("Export error:", error);
    }
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = readerEvent => {
            try {
                const content = readerEvent.target.result;
                const data = JSON.parse(content);
                if (data.campaigns && typeof data.campaigns === 'object' && confirm("This will overwrite all current campaign data. Are you sure?")) {
                    localStorage.setItem(campaignsKey, JSON.stringify(data.campaigns));
                    if (data.activeCampaignId) {
                        localStorage.setItem(activeCampaignIdKey, data.activeCampaignId);
                    }
                    alert('Data imported successfully! The page will now reload.');
                    window.location.reload();
                } else {
                    alert('Import cancelled or file is not a valid backup.');
                }
            } catch (error) {
                alert('Failed to read the file. Please ensure it is a valid JSON backup from this tool.');
                console.error("Import error:", error);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

</script>
</body>
</html>
